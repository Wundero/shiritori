name: CI

env:
    DJANGO_SETTINGS_MODULE: "config.settings.test"
    POETRY_VERSION: 1.4.1
    PYTHON_VERSION: 3.11

on:
    pull_request:
        branches: [ "main" ]

    push:
        branches: [ "main" ]

concurrency:
    group: ${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout Code Repository
                uses: actions/checkout@v3
            -   name: Build
                uses: ./.github/actions/build-action
            -   name: Ruff
                run: |
                    ruff check --format=github $(git ls-files '*.py')
            -   name: Black
                run: |
                    cd backend
                    poetry run black --check $(git ls-files '*.py')
            -   name: Isort
                run: |
                    cd backend
                    poetry run isort --check-only --profile black $(git ls-files '*.py')
    #            -   name: Mypy TODO: Fix mypy errors
    #                run: |
    #                    cd backend
    #                    poetry run mypy $(git ls-files '*.py')

    test:
        needs: lint
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout Code Repository
                uses: actions/checkout@v3

            -   name: Build
                uses: ./.github/actions/build-action
            -   name: Run DB Migrations
                run: |
                    cd backend
                    poetry run python manage.py migrate
            -   name: Run Django Tests
                run: |
                    cd backend
                    poetry run pytest
