name: CI

# Enable Buildkit and let compose use it to speed up image building
env:
    DOCKER_BUILDKIT: 1
    COMPOSE_DOCKER_CLI_BUILD: 1
    DJANGO_SETTINGS_MODULE: "config.settings.test"
    POETRY_VERSION: 1.4.1
    PYTHON_VERSION: 3.11

on:
    pull_request:
        branches: [ "master", "main" ]

    push:
        branches: [ "master", "main" ]

concurrency:
    group: ${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout Code Repository
                uses: actions/checkout@v3
            -   name: Build
                uses: ./.github/actions/build-action
            -   name: Ruff
                run: |
                    ruff check $(git ls-files '*.py')
            -   name: Black
                run: |
                    cd backend
                    poetry run black --check $(git ls-files '*.py')
            -   name: Isort
                run: |
                    cd backend
                    poetry run isort --check-only --profile black $(git ls-files '*.py')
    #            -   name: Mypy TODO: Fix mypy errors
    #                run: |
    #                    cd backend
    #                    poetry run mypy $(git ls-files '*.py')

    test:
        needs: lint
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout Code Repository
                uses: actions/checkout@v3

            -   name: Build
                uses: ./.github/actions/build-action
            -   name: Run DB Migrations
                run: |
                    cd backend
                    poetry run python manage.py migrate
            -   name: Run Django Tests
                run: |
                    cd backend
                    poetry run pytest


    deploy: # Build docker images and push to docker hub
        needs: test
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout Code Repository
                uses: actions/checkout@v3

            -   name: Build Docker Images
                run: |
                    docker-compose -f production.yml build
            -   name: Login to Docker Hub
                uses: docker/login-action@v2
                with:
                    username: ${{ secrets.DOCKER_USERNAME }}
                    password: ${{ secrets.DOCKER_PASSWORD }}
            -   name: Push Docker Images
                run: |
                    docker-compose -f production.yml push
